# Рекомендации для высокой доступности данных

В части высокой доступности данных в примере применены следующие механизмы:
- Несколько нод для данных
- Несколько реплик для индексов
- Индексы ротируются (`rollover`) по рекомендованной схеме, а именно:
    - По достижению индексом размера в 50ГБ, создается новый индекс, или
    - Каждый тридцать дней, создается новый индекс
- Данные отправляются в алиас (`alias`), который привязан к активному индексу, то есть ротация индекса не должна повлиять на работу схемы в примере

## Ротация индекса

Ротация индекса использует следующие сущности в ElasticSearch:
- Индексы и алиас (`alias`) индекса 
- Шаблона индекса (`index template`)
- Политика жизненного цикла индекса (`index lifecycle policy`)

Первый индекс в примере создается с цифровым суффиксом — это необходимо, чтобы в результате ротации создался новый индекс с измененным суффиксом.

На созданный индекс назначается алиас, который в процессе ротации переносится на новый индекс.

## Шаблон индекса

Шаблон индекса содержит все необходимые параметры для создания нового индекса в результате ротации:
- Паттерн индекса (`index pattern`). Новосозданные индексы, подпадающие под паттерн, будут автоматически созданы с параметрами шаблона.
- Настройки индекса. В нашем случае, это имя политики ротации (`index rollover policy`), количество реплик данных и `rollover_alias` - алиас, который будет перенесен на новый индекс.

```
{
  "index": {
    "lifecycle": {
      "name": "audit-trails-ilm",
      "rollover_alias": "audit-trails-index"
    },
    "number_of_replicas": "2"
  }
}
```

- Параметры сопоставления (`mapping`).

## Политика ротации

Политика ротации (`index lifecycle policy`) отслеживает "жизненный путь" наших данных.
По мере устаревания данных, данные можно переносить на менее производительные серверы или диски, а по истечении определенного времени — и, вовсе, удалить.

В нашем примере настроена только горячая фаза (`hot phase`) и была включена рекомендованный по умолчанию метрики для процедуры rollover.

Но в продуктивном развертывании рекомендуется спланировать, как процесс устаревания данных (перенос на "медленные" ноды), так и их удаление.

Удаление данных рекомендуется включить и при отсутствии других фаз, только для горячей фазы.

По истечении определенного времени, индексы с устаревшими данными будут удалены.
Если настроены снимки данных (`snapshots`) — можно включить опцию удаления только при наличии снимка.
В этом случае, необходимо указать имя политики создания снимков (`snapshot policy`)